<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>1xBet Crash Tracker</title>
  <style>
    #crashValue {
      font-size: 48px;
      font-weight: bold;
      transition: transform 0.3s;
    }
    #oddCircle {
      display: none;
      color: black;
      font-size: 32px;
    }
  </style>
</head>
<body>
  <div>
    Crash Value: <span id="crashValue">0.00</span>
    <span id="oddCircle">●</span>
  </div>
  <div id="dateTimeBox"></div>

  <script>
    let ws;
    const reconnectInterval = 5000;

    function openWebSocket() {
      const url = 'wss://1xbet.lk/games-frame/sockets/crash?ref=1&gr=911&whence=55&fcountry=208&appGuid=games-web-app-default-web-v3&lng=en&v=1.5';

      ws = new WebSocket(url);

      ws.onopen = () => {
        console.log('✅ WebSocket Connected');

        // Initial protocol negotiation
        ws.send('{"protocol":"json","version":1}\x1e');

        // Replace "Guest" with an authenticated target if needed
        // This depends on how 1xBet's backend identifies authenticated users
        ws.send('{"arguments":[{"activity":30,"currency":119}],"invocationId":"1","target":"Join","type":1}\x1e');
      };

      ws.onmessage = (event) => {
        try {
          const parts = event.data.split('\x1e').filter(Boolean);
          for (const part of parts) {
            const data = JSON.parse(part);
            if (data.target === 'OnCrash' && data.arguments?.[0]?.f) {
              updateCrashValue(data.arguments[0].f);
            }
          }
        } catch (err) {
          console.error('❌ Error parsing message:', err);
        }
      };

      ws.onclose = () => {
        console.warn('⚠️ WebSocket closed. Reconnecting...');
        setTimeout(openWebSocket, reconnectInterval);
      };

      ws.onerror = (error) => {
        console.error('❌ WebSocket error:', error);
      };
    }

    function updateCrashValue(value) {
      const crashValueEl = document.getElementById('crashValue');
      const oddCircle = document.getElementById('oddCircle');
      crashValueEl.innerText = value.toFixed(2);

      if (Math.floor(value) % 2 !== 0) {
        oddCircle.style.display = 'inline';
      } else {
        oddCircle.style.display = 'none';
      }

      crashValueEl.style.transform = 'scale(1.3)';
      setTimeout(() => {
        crashValueEl.style.transform = 'scale(1)';
      }, 300);
    }

    function updateDateTime() {
      const now = new Date();
      const formatted = now.toLocaleString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      document.getElementById('dateTimeBox').innerText = formatted;
    }

    // Start everything
    setInterval(updateDateTime, 1000);
    updateDateTime();
    openWebSocket();
  </script>
</body>
</html>
